<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GitHasher</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-200 font-mono h-screen flex flex-col overflow-hidden">

    <header class="bg-gray-800 border-b border-gray-700 p-4 flex items-center justify-between shadow-md z-10">
        <h1 class="text-xl font-bold text-emerald-400 tracking-wide">GitHasher</h1>
        <div id="status" class="text-sm text-yellow-400 hidden">Processing...</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <aside class="w-[45%] min-w-[300px] bg-gray-800 border-r border-gray-700 flex flex-col transition-all">
            
            <div class="p-4 border-b border-gray-700 space-y-3">
                <label class="text-xs text-gray-400 uppercase font-semibold">1. Repository</label>
                <input type="text" id="repo-url" placeholder="https://github.com/owner/repo" 
                       class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm focus:border-emerald-500 outline-none">
                
                <button onclick="fetchBranches()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded text-sm w-full transition">Get Branches</button>

                <select id="branch-select" onchange="fetchTree()" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm mt-2 disabled:opacity-50" disabled>
                    <option>Select Branch...</option>
                </select>
            </div>

            <div class="p-4 border-b border-gray-700 bg-gray-800 z-10 space-y-3">
                <div class="flex justify-between items-center">
                    <label class="text-xs text-gray-400 uppercase font-semibold">2. Filter Files (Glob)</label>
                    <span id="selection-count" class="text-xs text-emerald-400">0 selected</span>
                </div>
                
                <input type="text" id="include-glob" placeholder="Include: *.cpp, src/*, *.h" 
                       class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-green-300"
                       oninput="applyFilters()">
                
                <input type="text" id="exclude-glob" placeholder="Exclude: test/*, *.md" 
                       class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-xs text-red-300"
                       oninput="applyFilters()">
            </div>

            <div class="flex-1 overflow-y-auto p-2" id="file-tree">
                <div class="text-center text-gray-500 mt-10 text-sm">Load a branch to see files</div>
            </div>

            <div class="p-4 border-t border-gray-700">
                <button onclick="submitProcess()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded shadow-lg transition">
                    HASH & PREVIEW
                </button>
            </div>
        </aside>

        <main class="w-[55%] flex flex-col bg-gray-900 border-l border-gray-700">
            <div class="p-4 bg-gray-800 border-b border-gray-700 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-gray-500 text-xs">SHA512:</span>
                    <code id="hash-output" class="bg-black px-2 py-1 rounded text-xs text-yellow-400 font-mono select-all">---</code>
                </div>
            </div>
            <textarea id="preview-output" readonly class="flex-1 bg-[#0d1117] text-gray-300 p-4 font-mono text-xs resize-none focus:outline-none" placeholder="Content will appear here..."></textarea>
        </main>
    </div>

    <script>
        let currentOwner = "";
        let currentRepo = "";
        let allFiles = [];

        async function fetchBranches() {
            const url = document.getElementById('repo-url').value;
            const match = url.match(/github\.com\/([^\/]+)\/([^\/]+)/);
            if (!match) { alert("Invalid GitHub URL"); return; }
            currentOwner = match[1];
            currentRepo = match[2].replace(".git", "");

            const btn = event.target;
            btn.innerText = "Loading...";
            try {
                const res = await fetch(`/api/branches?owner=${currentOwner}&repo=${currentRepo}`);
                const branches = await res.json();
                const select = document.getElementById('branch-select');
                select.innerHTML = '<option>Select Branch...</option>';
                branches.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b; opt.innerText = b; select.appendChild(opt);
                });
                select.disabled = false;
            } catch(e) { alert("Error: " + e); }
            finally { btn.innerText = "Get Branches"; }
        }

        async function fetchTree() {
            const branch = document.getElementById('branch-select').value;
            if (!branch) return;
            document.getElementById('file-tree').innerHTML = '<div class="text-center text-yellow-400 mt-5">Fetching file tree...</div>';
            try {
                const res = await fetch(`/api/tree?owner=${currentOwner}&repo=${currentRepo}&branch=${branch}`);
                allFiles = await res.json();
                renderTree();
                applyFilters();
            } catch(e) { document.getElementById('file-tree').innerText = "Error loading tree."; }
        }

        function renderTree() {
            const container = document.getElementById('file-tree');
            container.innerHTML = "";
            allFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 py-1 px-2 hover:bg-gray-700 rounded cursor-pointer";
                div.onclick = (e) => {
                    if(e.target.type !== 'checkbox') {
                        const cb = document.getElementById(`cb-${index}`);
                        cb.checked = !cb.checked;
                        updateCount();
                    }
                };
                const cb = document.createElement('input');
                cb.type = "checkbox"; cb.id = `cb-${index}`;
                cb.className = "file-checkbox accent-emerald-500";
                cb.value = file.path; cb.onchange = updateCount;
                cb.checked = true; 
                const label = document.createElement('span');
                label.className = "text-xs truncate select-none";
                label.innerText = file.path;
                div.appendChild(cb); div.appendChild(label);
                container.appendChild(div);
            });
            updateCount();
        }

        function matchesGlob(filename, patternString) {
            if (!patternString || patternString.trim() === "") return false;
            
            const patterns = patternString.split(',').map(p => p.trim()).filter(p => p.length > 0);
            
            return patterns.some(p => {
                let regexBody = p.replace(/[.+^${}()|[\]\\]/g, '\\$&').replace(/\*/g, '.*');
                let re = new RegExp(`^${regexBody}$`, 'i'); // Case insensitive
                return re.test(filename);
            });
        }

        function applyFilters() {
            const incStr = document.getElementById('include-glob').value;
            const excStr = document.getElementById('exclude-glob').value;
            
            const hasInclude = incStr.trim().length > 0;
            const hasExclude = excStr.trim().length > 0;

            document.querySelectorAll('.file-checkbox').forEach(cb => {
                const path = cb.value;
                
                let matchesInc = hasInclude ? matchesGlob(path, incStr) : false;
                let matchesExc = hasExclude ? matchesGlob(path, excStr) : false;

                if (hasInclude) {
                    cb.checked = matchesInc && !matchesExc;
                } else if (hasExclude) {
                    cb.checked = !matchesExc;
                }
            });
            updateCount();
        }

        function updateCount() {
            document.getElementById('selection-count').innerText = 
                `${document.querySelectorAll('.file-checkbox:checked').length} selected`;
        }

        async function submitProcess() {
            const branch = document.getElementById('branch-select').value;
            const selectedPaths = Array.from(document.querySelectorAll('.file-checkbox:checked')).map(cb => cb.value);
            if (selectedPaths.length === 0) { alert("Select at least one file."); return; }

            document.getElementById('status').style.display = 'block';
            document.getElementById('preview-output').value = "Downloading and Hashing...";
            try {
                const res = await fetch('/api/process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ owner: currentOwner, repo: currentRepo, branch: branch, files: selectedPaths })
                });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                document.getElementById('preview-output').value = data.preview;
                document.getElementById('hash-output').innerText = data.hash;
            } catch(e) { 
                alert("Error: " + e.message); 
                document.getElementById('preview-output').value = "Error occurred.";
            } finally { document.getElementById('status').style.display = 'none'; }
        }
    </script>
</body>
</html>
